{"version":3,"sources":["admin-metablock.js","admin-test.js"],"names":["MetaBlock","shortcode_tag","me","this","add_btn_class","remove_btn_class","render_new","element_map","get_element_map","buttons","make_buttons","element_types","$","append","element_count","hide_all_elements","add_click_event_handlers","render_edit","inactive_elements","all_elements","get_element_map_array","forEach","element_id","filter","children","map","idx","elem","val","get","join","push","active_elements","el","includes","max_row","length","Math","max","apply","parseInt","match","parent","data","removeAttr","hide","attr","toggle_images","elements","on","event","preventDefault","$element","currentTarget","row","element_type","show_element","hide_element","off","each","index","element","trigger","find","click","show","animate","scrollTop","prop","element_is_visible","is","block_style_allows_images","toggle","toArray","item","pos","indexOf","arr","Array","_","i","x","reduce","y","concat","btn_HTML","type","jQuery","document","ready","wp","shortcake","hooks","addAction","shortcode"],"mappings":"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","file":"../admin-blocks.min.js","sourcesContent":["/* global wp */\n\nfunction MetaBlock(shortcode_tag) { // eslint-disable-line no-unused-vars\n\n  var me = this;\n  me.shortcode_tag = shortcode_tag;\n  me.add_btn_class  = me.shortcode_tag + '-add-element';\n  me.remove_btn_class  = me.shortcode_tag + '-remove-element';\n\n\n  /**\n   * Called when a new metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.render_new = function () {\n    var element_map = me.get_element_map();\n    var buttons = me.make_buttons(element_map.element_types);\n    var $shortcode_div = $('.shortcode-ui-edit-' + me.shortcode_tag);\n    $shortcode_div.append(buttons);\n    var element_count = element_map.element_count;\n    this.hide_all_elements(element_count);\n    this.add_click_event_handlers(element_count);\n  };\n\n  /**\n   * Called when en existing metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.render_edit = function () {\n\n    var element_map = me.get_element_map();\n    var element_types = element_map.element_types;\n    var element_count = element_map.element_count;\n\n    var buttons = me.make_buttons(element_types);\n    var $shortcode_div = $('.shortcode-ui-edit-' + me.shortcode_tag);\n    $shortcode_div.append(buttons);\n\n    var inactive_elements = [];\n    var all_elements = me.get_element_map_array(element_count, element_types);\n    all_elements.forEach(function (element_id) {\n        var input_values = $('.field-block')\n            .filter($('div[class$=\\'_' + element_id + '\\']'))\n            .children()\n            .filter($('input, textarea'))\n            .map(function (idx, elem) {\n              return $(elem).val();\n            }).get().join('');\n\n        if ('' === input_values) {\n          inactive_elements.push(element_id);\n        }\n    });\n\n    var active_elements = all_elements.filter(function(el) {\n      return !inactive_elements.includes(el);\n    });\n\n    var max_row = active_elements.length === 0 ? 0 :\n        Math.max.apply(null, active_elements.map(function(el) {\n          return parseInt(el.match(/\\d+$/g)[0]);\n        }));\n\n    $('.' + me.add_btn_class).parent().data('row', max_row);\n    max_row !== 0 && $('.' + me.remove_btn_class).removeAttr('disabled');\n\n    inactive_elements.map(function(element_id) {\n      $('.field-block').filter($('div[class$=\\'_' + element_id + '\\']')).hide();\n    });\n\n    if (all_elements.length - inactive_elements.length === element_count) {\n      $('.' + me.add_btn_class).attr('disabled', 'disabled');\n    }\n\n    this.toggle_images(element_count);\n    this.add_click_event_handlers(element_count);\n  };\n\n  /**\n   * Add click event handlers for add/remove buttons in metablock.\n   */\n  me.add_click_event_handlers = function (element_count) {\n    var elements = this;\n\n    // Add click event handlers for the elements.\n    $('.' + me.add_btn_class).on('click', function (event) {\n      event.preventDefault();\n      var $element = $(event.currentTarget);\n      var row = $element.parent().data('row');\n      var element_type = $element.data('element-type');\n\n      if (row <= element_count) {\n        // elements.show_element_type_selector();\n        elements.show_element(++row, element_type, element_count);\n        $element.parent().data('row', row);\n        $('.' + me.remove_btn_class).removeAttr('disabled');\n        if (row === element_count) {\n          $('.' + me.add_btn_class).attr('disabled', 'disabled');\n        }\n      }\n    });\n\n    $('.' + me.remove_btn_class).on('click', function (event) {\n      event.preventDefault();\n      var $element = $(event.currentTarget);\n      var row = $element.parent().data('row');\n\n      if (row >= 0) {\n        elements.hide_element(row--);\n        $element.parent().data('row', row);\n        $('.' + me.add_btn_class).removeAttr('disabled');\n        if (row === 0) {\n          $element.attr('disabled', 'disabled');\n        }\n      }\n    });\n\n    $('input[name=elements_block_style]').off('click').on('click', function() {\n      me.toggle_images(element_count);\n    });\n  };\n\n  /**\n   * Hide a metablock row and reset the values of it's fields.\n   *\n   * @param row\n   */\n  me.hide_element = function (row) {\n    var $element = $('.field-block').filter($('div[class$=\\'_' + row + '\\']'));\n    // Clear all text, textarea fields for this row/element.\n    $element.\n      children().\n      filter($('input, textarea')).each(function (index, element) {\n        $(element).val('').trigger('input');\n      });\n    // Clear image attachment if set in this row/element.\n    $element.\n      find($('.attachment-previews .remove')).each(function (index, element) {\n        $(element).click();\n      });\n    // Hide element's fields.\n    $element.hide(300);\n  };\n\n  /**\n   * Hide all metablock rows.\n   *\n   * @param row\n   */\n  me.hide_all_elements = function (element_count) {\n    me.get_element_map_array(element_count).forEach(function (row) {\n      $( '.field-block' ).filter( $( 'div[class$=\\'_'+row+'\\']' ) ).hide();\n    });\n  };\n\n  /**\n   * Show a metablock elements selector and scroll to bottom.\n   *\n   * @param row\n   */\n  me.show_element = function (row, element_type, element_count) {\n    $('.field-block').filter($('div[class$=\\'_' + element_type + '_' +row + '\\']')).show(300, function () {\n      me.toggle_images(element_count);\n      $('.media-frame-content').animate({\n        scrollTop: $('.shortcode-ui-content').prop('scrollHeight'),\n      }, 300);\n    });\n  };\n\n  /**\n   * Show/hide images inputs depending on element block style.\n   */\n  me.toggle_images = function(element_count) {\n    me.get_element_map_array(element_count).forEach(function(row) {\n      var element_is_visible = $('.field-block').filter($('div[class$=\\'title_' + row + '\\']')).is(':visible');\n      var block_style_allows_images = 'no_image' != $('input[name=elements_block_style]:checked').val();\n      $('.shortcode-ui-attribute-attachment_'+ row).toggle(element_is_visible && block_style_allows_images);\n    });\n  };\n\n  /**\n   * Called when a new metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.get_element_map = function() {\n\n    var element_types = $('[data-element-type]')\n      .map( function() {\n        return $(this).data('element-type');\n      }).toArray();\n    element_types = element_types.filter(function(item, pos) {\n      return element_types.indexOf(item) == pos;\n    });\n\n    var element_count = $('[data-element-number]')\n      .map( function() {\n        return $(this).data('element-number');\n      }).toArray();\n    element_count = Math.max.apply(null, element_count); \n\n    return {\n      element_types: element_types,\n      element_count: element_count\n    };\n\n  };\n\n  me.get_element_map_array = function(element_count, element_types) {\n    var arr = Array.apply(null, Array(element_count));\n    arr = arr.map(function (_, i) { return i + 1; });\n    if(element_types) {\n      arr = arr\n        .map(function(x) {\n          return element_types\n            .map(function(el) {\n              return el + '_' + x;\n            }, []);})\n        .reduce(function(x, y) {\n          return x.concat(y);\n        });\n    }\n    return arr;\n  };\n\n  /**\n   * Called when a new metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.make_buttons = function(element_types) {\n    var btn_HTML = '<div data-row=\"0\">';\n    element_types.map( function(type) {\n      btn_HTML += (\n        '<button class=\"button button-small ' + me.add_btn_class + '\" data-element-type=\"' + type + '\">Add ' + type + '</button>'\n      );\n    });\n    btn_HTML += '<button class=\"button button-small ' + me.remove_btn_class + '\" disabled=\"disabled\">Remove Element</button></div>';\n    return btn_HTML;\n  };\n\n}\n\n\njQuery(document).ready(function() {\n\n  // Attach hooks when rendering a new metablock.\n  wp.shortcake.hooks.addAction('shortcode-ui.render_new', function (shortcode) {\n    var shortcode_tag = shortcode.get('shortcode_tag');\n    var mb = new MetaBlock(shortcode_tag);\n    mb.render_new();\n  });\n\n  // Trigger hooks when shortcode renders an existing metablock.\n  wp.shortcake.hooks.addAction('shortcode-ui.render_edit', function (shortcode) {\n    var shortcode_tag = shortcode.get('shortcode_tag');\n    var mb = new MetaBlock(shortcode_tag);\n    mb.render_edit();\n  });\n\n});\n","jQuery(document).ready(function() {\n  // console.log('TEST OK');\n});\n"]}