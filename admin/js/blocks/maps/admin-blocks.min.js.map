{"version":3,"sources":["admin-metablock.js"],"names":["MetaBlock","shortcode_tag","required_image","me","this","add_btn_class","remove_btn_class","render_new","element_map","get_element_map","buttons","make_buttons","$","append","element_count","hide_all_elements","add_click_event_handlers","render_edit","element_types","inactive_elements","all_elements","get_element_map_array","forEach","element_id","$element","filter","input_values","children","map","idx","elem","val","get","join","$preview_images","find","length","push","active_elements","el","includes","max_row","Math","max","apply","parseInt","match","parent","data","removeAttr","prop","trigger","hide","attr","toggle_images","elements","on","event","preventDefault","currentTarget","row","element_type","selectName","select2","placeholder","show_element","hide_element","off","show","each","animate","scrollTop","element_is_visible","is","block_style_allows_images","toggle","toArray","item","pos","indexOf","element_names","arr","Array","_","i","x","reduce","y","concat","btn_HTML","types","names","type","jQuery","document","ready","allowed_shortcodes","wp","shortcake","hooks","addAction","shortcode"],"mappings":"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","file":"../admin-blocks.min.js","sourcesContent":["/* eslint no-console: [\"error\", { allow: [\"log\", \"warn\", \"error\"] }] */\n/* global wp */\n\nfunction MetaBlock(shortcode_tag, required_image) { // eslint-disable-line no-unused-vars\n\n  var me = this;\n  me.shortcode_tag = shortcode_tag;\n  me.add_btn_class  = me.shortcode_tag + '-add-element';\n  me.remove_btn_class  = me.shortcode_tag + '-remove-element';\n  me.required_image = required_image || false;\n\n\n  /**\n   * Called when a new metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.render_new = function () {\n    var element_map = me.get_element_map();\n    var buttons = me.make_buttons(element_map);\n    var $shortcode_div = $('.shortcode-ui-edit-' + me.shortcode_tag);\n    $shortcode_div.append(buttons);\n    var element_count = element_map.element_count;\n    this.hide_all_elements(element_count);\n    this.add_click_event_handlers(element_count);\n  };\n\n  /**\n   * Called when en existing metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.render_edit = function () {\n\n    var element_map = me.get_element_map();\n    var element_types = element_map.element_types;\n    var element_count = element_map.element_count;\n\n    var buttons = me.make_buttons(element_map);\n    var $shortcode_div = $('.shortcode-ui-edit-' + me.shortcode_tag);\n    $shortcode_div.append(buttons);\n\n    var inactive_elements = [];\n    var all_elements = me.get_element_map_array(element_count, element_types);\n    all_elements.forEach(function (element_id) {\n      var $element = $('.field-block')\n        .filter($('div[class$=\\'_' + element_id + '\\']'));\n      var input_values = $element\n        .children()\n        .filter($('input, textarea, select'))\n        .map(function (idx, elem) {\n          return $(elem).val();\n        }).get().join('');\n      var $preview_images = me.required_image ? $element.find('.attachment-previews .attachment-preview') : null;\n      if ('' === input_values && (!me.required_image || $preview_images.length == 0)) {\n        inactive_elements.push(element_id);\n      }\n    });\n\n    var active_elements = all_elements.filter(function(el) {\n      return !inactive_elements.includes(el);\n    });\n\n    var max_row = active_elements.length === 0 ? 0 :\n      Math.max.apply(null, active_elements.map(function(el) {\n        return parseInt(el.match(/\\d+$/g)[0]);\n      }));\n\n    $('.' + me.add_btn_class).parent().data('row', max_row);\n    max_row !== 0 && $('.' + me.remove_btn_class).removeAttr('disabled');\n\n    inactive_elements.map(function(element_id) {\n      var $element = $('.field-block').filter($('div[class$=\\'_' + element_id + '\\']'));\n      $element.find('input[type=\"checkbox\"], input[type=\"radio\"]').prop('checked', false).trigger('change');\n      $element.hide();\n    });\n\n    if (all_elements.length - inactive_elements.length === element_count) {\n      $('.' + me.add_btn_class).attr('disabled', 'disabled');\n    }\n\n    this.toggle_images(element_count);\n    this.add_click_event_handlers(element_count);\n  };\n\n  /**\n   * Add click event handlers for add/remove buttons in metablock.\n   */\n  me.add_click_event_handlers = function (element_count) {\n    var elements = this;\n\n    // Add click event handlers for the elements.\n    $('.' + me.add_btn_class).on('click', function (event) {\n      event.preventDefault();\n      var $element = $(event.currentTarget);\n      var row = $element.parent().data('row');\n      var element_type = $element.data('element-type');\n\n      // Special control, if block type added is post, and if input element has special data attribute data-input-transform == js-select2-enable then dynamically transform into select2\n      if (element_type == 'post') {\n        var selectName = 'select[name=\"post_post_'+ (row+1) +'\"]';\n        if ( $(selectName).data('input-transform') === 'js-select2-enable' ) {\n          $(selectName).select2({\n            placeholder: 'Select post',\n          });\n        }\n      }\n\n      if (row <= element_count) {\n        // elements.show_element_type_selector();\n        elements.show_element(++row, element_type, element_count);\n        $element.parent().data('row', row);\n        $('.' + me.remove_btn_class).removeAttr('disabled');\n        if (row === element_count) {\n          $('.' + me.add_btn_class).attr('disabled', 'disabled');\n        }\n      }\n    });\n\n    $('.' + me.remove_btn_class).on('click', function (event) {\n      event.preventDefault();\n      var $element = $(event.currentTarget);\n      var row = $element.parent().data('row');\n\n      if (row >= 0) {\n        elements.hide_element(row--);\n        $element.parent().data('row', row);\n        $('.' + me.add_btn_class).removeAttr('disabled');\n        if (row === 0) {\n          $element.attr('disabled', 'disabled');\n        }\n      }\n    });\n\n    $('input[name=elements_block_style]').off('click').on('click', function() {\n      me.toggle_images(element_count);\n    });\n  };\n\n  /**\n   * Hide a metablock row and reset the values of it's fields.\n   *\n   * @param row\n   */\n  me.hide_element = function (row) {\n    var $element = $('.field-block').filter($('div[class$=\\'_' + row + '\\']'));\n    // Disable all text, textarea fields for this row/element.\n    $element.find('input[type=\"checkbox\"], input[type=\"radio\"]').prop('checked', false).trigger('change');\n    $element.find('input:not([type=\"checkbox\"]):not([type=\"radio\"]), textarea').val('').trigger('input').trigger('change');\n    if(me.required_image) {\n      $element.find('.attachment-previews .attachment-preview .button.remove').trigger('click');\n    }\n    $element.hide(300);\n  };\n\n  /**\n   * Hide all metablock rows.\n   *\n   * @param row\n   */\n  me.hide_all_elements = function (element_count) {\n    me.get_element_map_array(element_count).forEach(function (row) {\n      var $element = $('.field-block').filter($('div[class$=\\'_' + row + '\\']'));\n      $element.find('input[type=\"checkbox\"], input[type=\"radio\"]').prop('checked', false).trigger('change');\n      $element.hide();\n    });\n  };\n\n  /**\n   * Show a metablock elements selector and scroll to bottom.\n   *\n   * @param row\n   */\n  me.show_element = function (row, element_type, element_count) {\n    $('.field-block').filter($('div[class$=\\'_' + element_type + '_' +row + '\\']')).show(300, function () {\n      $(this).find('input[type=\"checkbox\"][checked], input[type=\"radio\"][checked]').each(function() {\n        $(this).prop('checked', true).trigger('change');\n      });\n      me.toggle_images(element_count);\n      $('.media-frame-content').animate({\n        scrollTop: $('.shortcode-ui-content').prop('scrollHeight'),\n      }, 300);\n    });\n  };\n\n  /**\n   * Show/hide images inputs depending on element block style.\n   */\n  me.toggle_images = function(element_count) {\n    me.get_element_map_array(element_count).forEach(function(row) {\n      var element_is_visible = $('.field-block').filter($('div[class$=\\'title_' + row + '\\']')).is(':visible');\n      var block_style_allows_images = 'no_image' != $('input[name=elements_block_style]:checked').val();\n      $('.shortcode-ui-attribute-attachment_'+ row).toggle(element_is_visible && block_style_allows_images);\n    });\n  };\n\n  /**\n   * Called when a new metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.get_element_map = function() {\n\n    var element_types = $('[data-element-type]')\n      .map( function() {\n        return $(this).data('element-type');\n      }).toArray();\n    element_types = element_types.filter(function(item, pos) {\n      return element_types.indexOf(item) == pos;\n    });\n\n    var element_names = $('[data-element-name]')\n      .map( function() {\n        return $(this).data('element-name');\n      }).toArray();\n    element_names = element_names.filter(function(item, pos) {\n      return element_names.indexOf(item) == pos;\n    });\n\n    var element_count = $('[data-element-number]')\n      .map( function() {\n        return $(this).data('element-number');\n      }).toArray();\n    element_count = Math.max.apply(null, element_count);\n\n    return {\n      element_types: element_types,\n      element_names: element_names,\n      element_count: element_count\n    };\n\n  };\n\n  me.get_element_map_array = function(element_count, element_types) {\n    var arr = Array.apply(null, Array(element_count));\n    arr = arr.map(function (_, i) { return i + 1; });\n    if(element_types) {\n      arr = arr\n        .map(function(x) {\n          return element_types\n            .map(function(el) {\n              return el + '_' + x;\n            }, []);})\n        .reduce(function(x, y) {\n          return x.concat(y);\n        });\n    }\n    return arr;\n  };\n\n  /**\n   * Called when a new metablock is rendered in the backend.\n   * @param shortcode Shortcake backbone model.\n   */\n  me.make_buttons = function(element_map) {\n    var btn_HTML = '<div data-row=\"0\">';\n    var types = element_map.element_types;\n    var names = element_map.element_names;\n    if( names.length !== types.length ) { names = types; }\n    types.map( function(type, idx) {\n      btn_HTML += (\n        '<button class=\"button button-small ' + me.add_btn_class + '\" data-element-type=\"' + type + '\">Add ' + names[idx] + '</button>'\n      );\n    });\n    btn_HTML += '<button class=\"button button-small ' + me.remove_btn_class + '\" disabled=\"disabled\">Remove Element</button></div>';\n    return btn_HTML;\n  };\n\n}\n\n\njQuery(document).ready(function() {\n\n  var allowed_shortcodes = [\n    'shortcake_metablock',\n    'shortcake_mixed_content_row',\n    'shortcake_repeater',\n    'shortcake_milestones',\n    'shortcake_slideshow',\n    'shortcake_world_slideshow',\n    'shortcake_link_list',\n    'shortcake_people_list',\n    'shortcake_accordion_list',\n    'shortcake_launcher_card',\n    'shortcake_grid_images',\n    'shortcake_donation_block',\n    'shortcake_hero_set',\n    'shortcake_steps_set',\n    'shortcake_mc_subscription',\n  ];\n\n  var required_image = [\n    'shortcake_grid_images',\n    'shortcake_hero_set',\n  ];\n\n  // Attach hooks when rendering a new metablock.\n  wp.shortcake.hooks.addAction('shortcode-ui.render_new', function (shortcode) {\n    var shortcode_tag = shortcode.get('shortcode_tag');\n    if(allowed_shortcodes.includes(shortcode_tag)) {\n      var mb = new MetaBlock(shortcode_tag, required_image.includes(shortcode_tag));\n      mb.render_new();\n    }\n  });\n\n  // Trigger hooks when shortcode renders an existing metablock.\n  wp.shortcake.hooks.addAction('shortcode-ui.render_edit', function (shortcode) {\n    var shortcode_tag = shortcode.get('shortcode_tag');\n    if(allowed_shortcodes.includes(shortcode_tag)) {\n      var mb = new MetaBlock(shortcode_tag, required_image.includes(shortcode_tag));\n      mb.render_edit();\n    }\n  });\n\n});\n"]}